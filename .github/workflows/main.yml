name: Build Data Crawler App

on:
  push:
    branches: [main]
    tags: ['v*']
  workflow_dispatch:

jobs:
  build-macos:
    runs-on: macos-latest
    strategy:
      matrix:
        python-version: [3.11]
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: ${{ matrix.python-version }}
        cache: 'pip'
    
    - name: Install system dependencies
      run: |
        brew update
        brew install curl  # 改为 curl，不是 libcurl
        brew install openssl
        brew install zlib
        brew install xz
    
    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip
        pip install wheel setuptools
        pip install -r requirements.txt
        pip install pyinstaller
    
    - name: Test imports
      run: |
        python -c "
        try:
            import curl_cffi
            print('✓ curl_cffi imported successfully')
            from curl_cffi import requests as cffi_requests
            print('✓ curl_cffi.requests imported successfully')
            import requests
            print('✓ requests imported successfully')
            from bs4 import BeautifulSoup
            print('✓ BeautifulSoup imported successfully')
            from docx import Document
            print('✓ docx imported successfully')
            from PIL import Image
            print('✓ PIL imported successfully')
            import tkinter
            print('✓ tkinter imported successfully')
            print('✅ All imports OK!')
        except Exception as e:
            print(f'❌ Import failed: {e}')
            import traceback
            traceback.print_exc()
            exit(1)
        "
    
    - name: Build macOS Application (Debug Mode)
      env:
        MACOSX_DEPLOYMENT_TARGET: "11.0"
      run: |
        echo "=== Starting PyInstaller build ==="
        
        # 方法1：直接使用命令行参数（推荐）
        echo "方法1: 直接使用命令行参数构建"
        pyinstaller --onedir --name "数据采集助手" \
          --add-data "eastmoney_crawler.py:." \
          --add-data "pbc_crawler.py:." \
          --hidden-import=curl_cffi \
          --hidden-import=curl_cffi.requests \
          --hidden-import=lxml.etree \
          --hidden-import=lxml._elementpath \
          --hidden-import=PIL._tkinter_finder \
          --hidden-import=requests \
          --hidden-import=bs4 \
          --hidden-import=tkinter \
          --clean \
          crawler_gui.py 2>&1 | tee build.log
        
        echo "=== Build complete ==="
        echo "Build log saved to build.log"
        
        # 检查构建产物
        echo "=== Checking build artifacts ==="
        ls -la dist/
        if [ -d "dist/数据采集助手" ]; then
          ls -la "dist/数据采集助手/"
          echo "✅ Build directory exists"
        else
          echo "❌ Build directory not found"
          exit 1
        fi
    
    - name: Upload macOS Artifact
      if: success()
      uses: actions/upload-artifact@v4
      with:
        name: 数据采集助手-macOS
        path: dist/数据采集助手

  build-windows:
    runs-on: windows-latest
    strategy:
      matrix:
        python-version: [3.11]
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: ${{ matrix.python-version }}
        cache: 'pip'
    
    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip
        pip install wheel setuptools
        pip install -r requirements.txt
        pip install pyinstaller
    
    - name: Test imports
      run: |
        python -c "
        try:
            import curl_cffi
            print('curl_cffi imported successfully')
            from curl_cffi import requests as cffi_requests
            print('curl_cffi.requests imported successfully')
            import requests
            print('requests imported successfully')
            from bs4 import BeautifulSoup
            print('BeautifulSoup imported successfully')
            from docx import Document
            print('docx imported successfully')
            from PIL import Image
            print('PIL imported successfully')
            import tkinter
            print('tkinter imported successfully')
            print('All imports OK!')
        except Exception as e:
            print(f'Import failed: {e}')
            import traceback
            traceback.print_exc()
            exit(1)
        "
    
    - name: Build Windows Application
      run: |
        echo "=== Starting Windows PyInstaller build ==="
        
        echo "方法1: 直接使用命令行参数构建"
        pyinstaller --onedir --name "数据采集助手" `
          --add-data "eastmoney_crawler.py;." `
          --add-data "pbc_crawler.py;." `
          --hidden-import=curl_cffi `
          --hidden-import=curl_cffi.requests `
          --hidden-import=lxml.etree `
          --hidden-import=lxml._elementpath `
          --hidden-import=PIL._tkinter_finder `
          --hidden-import=requests `
          --hidden-import=bs4 `
          --hidden-import=tkinter `
          --clean `
          crawler_gui.py 2>&1 | tee build.log
        
        echo "=== Windows build complete ==="
        echo "Build log saved to build.log"
        
        # 检查构建产物
        echo "=== Checking Windows build artifacts ==="
        dir dist\
        if exist "dist\数据采集助手\数据采集助手.exe" (
          echo "✅ Executable exists"
        ) else (
          echo "❌ Executable not found"
          exit 1
        )
    
    - name: Upload Windows Artifact
      if: success()
      uses: actions/upload-artifact@v4
      with:
        name: 数据采集助手-Windows
        path: dist\数据采集助手\数据采集助手.exe
